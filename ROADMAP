# **MilkStack Hub: Engineering Roadmap**

*   **Objective:** Evolve the MilkStack Hub from a conversational tool into a robust, efficient, and autonomous AI development environment capable of handling complex projects from plan to execution.
*   **Benchmark for Success:** The Hub should be able to process a project plan like "StimChat", allow agents to architect, critique, and build it, without hitting prohibitive quota limits or freezing the UI.

## **Phase 0: Triage & Stability (Immediate Priority)**

*Goal: Fix show-stopping bugs that currently inhibit the application's core functionality. This is our foundation.*

-   [ ] **Fix Critical Bug: AI Service Settings**
    -   **Task:** Modify `src/services/geminiService.ts` to fetch settings from `indexedDbService.ts`, not `projectService.ts`.
    -   **Reason:** Corrects the "API key not configured" error and makes the settings modal functional.

-   [ ] **Fix Critical Bug: Initial Message on Project Creation**
    -   **Task:** Refactor `App.tsx` to handle sending the first message in a new project reliably.
    -   **Reason:** Fixes the stale closure bug and ensures the "Initial Message" feature works as intended.

-   [ ] **Consolidate Redundant Keyboard Shortcut Listeners**
    -   **Task:** Merge the two `useEffect` hooks for keyboard shortcuts in `App.tsx` into one.
    -   **Reason:** Eliminates conflicting shortcuts (`Cmd+K`) and improves code maintainability.

-   [ ] **Fix Prop-Drilling Bug for Project Actions**
    -   **Task:** Ensure `onRenameProject` and `onDeleteProject` props are passed from `Sidebar.tsx` to `ProjectSelector.tsx`.
    -   **Reason:** Makes the rename and delete buttons in the UI functional.

## **Phase 1: Architectural Foundation & Quota Mitigation**

*Goal: Re-architect for scalability and implement the most critical solutions to manage API costs and prevent rate-limiting. This phase makes the app sustainable.*

-   [ ] **Epic: Centralized State Management (Pillar 1)**
    -   [ ] **Install Zustand:** Add the dependency.
    -   [ ] **Create `projectStore.ts`:** Define state and actions for projects, active project, and loading status.
    -   [ ] **Refactor `App.tsx`:** Replace component-level state with the new Zustand store. This will dramatically simplify logic and prevent future state-related bugs.

-   [ ] **Epic: Intelligent Orchestration for Quota Management (Pillar 2)**
    -   [ ] **Implement Cost-Aware Model Switching:**
        -   **Action:** Upgrade the `Orchestrator` prompt to output JSON including a `model` recommendation (`pro` vs. `flash`).
        -   **Action:** Update `geminiService.ts` to parse this JSON and dynamically select the appropriate model for the specialist agent.
        -   **Reason:** The single most effective way to manage RPM limits. Simple tasks will use the high-RPM `flash` model, saving the low-RPM `pro` model for complex work.

    -   [ ] **Implement Conversation Summarization:**
        -   **Action:** Create a `summarizationService.ts` that uses the `flash` model to condense long conversation histories.
        -   **Action:** Integrate this service into `getAgentResponse`. When the conversation history exceeds a token threshold, replace the oldest messages with a concise summary.
        -   **Reason:** Drastically reduces the token cost of each API call in long-running projects.

## **Phase 2: The Intelligence & UX Upgrade**

*Goal: Make the application smarter about the code it handles and faster for the user to operate.*

-   [ ] **Epic: Semantic Codebase Layer (Pillar 2)**
    -   [ ] **Integrate Client-Side Embeddings:** Add a library like `transformers.js` to the project.
    -   [ ] **Create `codebaseIntelligenceService.ts`:** Implement logic to generate vector embeddings for code chunks.
    -   [ ] **Update IndexedDB & Processing Flow:** Add a table for embeddings. When a codebase is added, process it into chunks and store the embeddings.
    -   [ ] **Integrate Semantic Search:** Modify `getAgentResponse` to perform a semantic search on the user's query and inject only the most relevant code snippets as context.
    -   **Reason:** Massively improves agent accuracy while reducing input token costs by 90%+.

-   [ ] **Epic: Power-User Experience Enhancements**
    -   [ ] **Implement Command Palette (Pillar 4):**
        -   **Action:** Create a `CommandPalette.tsx` modal.
        -   **Action:** Wire it to `Cmd+K` and populate it with core actions (switch project, open settings, etc.).
        -   **Reason:** Transforms the UX to match professional developer tools and improves workflow speed.
    -   [ ] **Offload Processing to Web Worker (Pillar 5):**
        -   **Action:** Move the `processCodebase` logic into a Web Worker.
        -   **Action:** Update the `NewProjectModal` to use this worker.
        -   **Reason:** Prevents the UI from freezing when uploading large codebases, ensuring a smooth and responsive user experience.

## **Phase 3: The Leap to Autonomy**

*Goal: Fulfill the core vision of the Hub by giving agents the ability to execute tasks and directly interact with code, turning them from advisors into actors.*

-   [ ] **Epic: Agent Tooling & Sandboxed Code Execution (Pillar 3)**
    -   [ ] **Integrate WebContainers:** Add the library to enable a browser-based Node.js environment.
    -   [ ] **Create `sandboxService.ts`:** Abstract the logic for running commands and capturing output.
    -   [ ] **Upgrade `geminiService` for Tool Calls:** Implement logic to parse `<tool_code>` blocks from agent responses, execute them via the sandbox, and feed the results back into the conversation.
    -   [ ] **Update Agent Prompts:** Explicitly teach the `Builder` and `Debug Specialist` agents how to use the new code execution tool.

-   [ ] **Epic: Real-World Code Interaction**
    -   [ ] **Implement Local File System Access:**
        -   **Action:** Create a `fileSystemService.ts` using the File System Access API.
        -   **Action:** Define a new tool for agents, `writeFile(filePath, content)`, that our application intercepts.
        -   **Action:** When the tool is called, prompt the user for permission to save the file.
        -   **Reason:** Allows agents to directly apply the code they write to the user's local machine, completing the development loop.
    -   [ ] **Implement GitHub Push Integration:**
        -   **Action:** Extend `githubService.ts` with a `commitFileChange` function that uses the GitHub REST API.
        -   **Action:** Define a new tool for agents, `commitToGitHub(filePath, newContent, commitMessage)`, that uses the user's PAT.
        -   **Reason:** Enables a full CI/CD workflow, where agents can autonomously push fixes or features to a repository.
